<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador RLC con Método de Euler</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjs@11.6.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .circuit-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        .circuit-params {
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            flex: 1;
            min-width: 300px;
            background: #f9f9f9;
        }
        .graph-container {
            margin-top: 30px;
            width: 100%;
            height: 500px;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        input {
            width: 120px;
            padding: 8px;
            margin: 6px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            padding: 10px 20px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #3367d6;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid #ddd;
            border-bottom: none;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #4285f4;
            color: white;
        }
        h2 {
            color: #4285f4;
            margin-top: 0;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ef9a9a;
        }
        .success {
            background-color: #e8f5e9;
            color: #2e7d32;
            border: 1px solid #a5d6a7;
        }
        .simulation-params {
            margin-top: 15px;
            padding: 15px;
            background: #f0f7ff;
            border-radius: 5px;
        }
        .results-panel {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
            border-left: 4px solid #4285f4;
        }
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .result-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .result-value {
            font-weight: bold;
            color: #4285f4;
            font-size: 1.1em;
        }
        .result-label {
            font-size: 0.9em;
            color: #666;
        }
        .value-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .value-table th, .value-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .value-table th {
            background-color: #f2f2f2;
        }
        .value-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .section-title {
            margin-top: 25px;
            color: #4285f4;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }
        .method-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border-left: 4px solid #2e7d32;
        }
    </style>
</head>
<body>
    <h1>Simulador Avanzado de Circuitos RLC con Método de Euler</h1>
    
    <div class="tabs">
        <div class="tab active" id="tab-serie">Circuito Serie</div>
        <div class="tab" id="tab-paralelo">Circuito Paralelo</div>
    </div>
    
    <div id="serie-tab" class="tab-content">
        <div class="circuit-params">
            <h2>Circuito RLC Serie</h2>
            <div>
                <label>Resistencia (Ω):</label>
                <input type="number" id="R_serie" value="100" step="1" min="0.1">
            </div>
            <div>
                <label>Inductancia (H):</label>
                <input type="number" id="L_serie" value="0.1" step="0.01" min="0.001">
            </div>
            <div>
                <label>Capacitancia (F):</label>
                <input type="number" id="C_serie" value="0.001" step="0.0001" min="0.000001">
            </div>
            <div>
                <label>Voltaje inicial (V):</label>
                <input type="number" id="V0_serie" value="10" step="1">
            </div>
            <div>
                <label>Corriente inicial (A):</label>
                <input type="number" id="I0_serie" value="0" step="0.1">
            </div>
            
            <div class="simulation-params">
                <h3>Parámetros de Simulación</h3>
                <div>
                    <label>Tiempo final (s):</label>
                    <input type="number" id="tmax_serie" value="0.5" step="0.1" min="0.01">
                </div>
                <div>
                    <label>Paso de tiempo (s):</label>
                    <input type="number" id="dt_serie" value="0.0001" step="0.00001" min="0.000001">
                </div>
            </div>
            
            <button id="btn-serie">Simular Circuito Serie</button>
            <div id="status-serie" class="status"></div>
            
            <div id="results-serie" class="results-panel" style="display: none;">
                <h3>Resultados de la Simulación</h3>
                <div class="results-grid" id="circuit-params-serie"></div>
                
                <h4 class="section-title">Valores en Puntos Clave</h4>
                <table class="value-table" id="key-values-serie">
                    <thead>
                        <tr>
                            <th>Tiempo (s)</th>
                            <th>Voltaje (V)</th>
                            <th>Corriente (A)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div class="method-info">
                    <h4>Información del Método Numérico</h4>
                    <p>Esta simulación utiliza el <strong>Método de Euler</strong> para resolver las ecuaciones diferenciales del circuito.</p>
                    <p><strong>Fórmulas implementadas:</strong></p>
                    <ul>
                        <li>dVc/dt = Il/C</li>
                        <li>dIl/dt = (-Vc - R*Il)/L</li>
                    </ul>
                    <p>Precisión: Los resultados pueden variar según el paso de tiempo seleccionado. Valores más pequeños de Δt producen resultados más precisos pero requieren más cálculos.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div id="paralelo-tab" class="tab-content" style="display:none;">
        <div class="circuit-params">
            <h2>Circuito RLC Paralelo</h2>
            <div>
                <label>Resistencia (Ω):</label>
                <input type="number" id="R_paralelo" value="100" step="1" min="0.1">
            </div>
            <div>
                <label>Inductancia (H):</label>
                <input type="number" id="L_paralelo" value="0.1" step="0.01" min="0.001">
            </div>
            <div>
                <label>Capacitancia (F):</label>
                <input type="number" id="C_paralelo" value="0.001" step="0.0001" min="0.000001">
            </div>
            <div>
                <label>Voltaje inicial (V):</label>
                <input type="number" id="V0_paralelo" value="10" step="1">
            </div>
            <div>
                <label>Corriente inicial (A):</label>
                <input type="number" id="I0_paralelo" value="0" step="0.1">
            </div>
            
            <div class="simulation-params">
                <h3>Parámetros de Simulación</h3>
                <div>
                    <label>Tiempo final (s):</label>
                    <input type="number" id="tmax_paralelo" value="0.5" step="0.1" min="0.01">
                </div>
                <div>
                    <label>Paso de tiempo (s):</label>
                    <input type="number" id="dt_paralelo" value="0.0001" step="0.00001" min="0.000001">
                </div>
            </div>
            
            <button id="btn-paralelo">Simular Circuito Paralelo</button>
            <div id="status-paralelo" class="status"></div>
            
            <div id="results-paralelo" class="results-panel" style="display: none;">
                <h3>Resultados de la Simulación</h3>
                <div class="results-grid" id="circuit-params-paralelo"></div>
                
                <h4 class="section-title">Valores en Puntos Clave</h4>
                <table class="value-table" id="key-values-paralelo">
                    <thead>
                        <tr>
                            <th>Tiempo (s)</th>
                            <th>Voltaje (V)</th>
                            <th>Corriente (A)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
                
                <div class="method-info">
                    <h4>Información del Método Numérico</h4>
                    <p>Esta simulación utiliza el <strong>Método de Euler</strong> para resolver las ecuaciones diferenciales del circuito.</p>
                    <p><strong>Fórmulas implementadas:</strong></p>
                    <ul>
                        <li>dVc/dt = Il/C - Vc/(R*C)</li>
                        <li>dIl/dt = -Vc/L</li>
                    </ul>
                    <p>Precisión: Los resultados pueden variar según el paso de tiempo seleccionado. Valores más pequeños de Δt producen resultados más precisos pero requieren más cálculos.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="graph-container">
        <h2>Respuesta Temporal del Circuito</h2>
        <canvas id="responseChart"></canvas>
    </div>

    <script>
        // Variables globales
        let responseChart = null;
        let currentSimulationData = null;
        
        // Función para mostrar mensajes de estado
        function showStatus(tab, message, isError = false) {
            const statusElement = document.getElementById(`status-${tab}`);
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            statusElement.className = isError ? 'status error' : 'status success';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);
        }
        
        // Función para cambiar entre pestañas
        function setupTabs() {
            const tabSerie = document.getElementById('tab-serie');
            const tabParalelo = document.getElementById('tab-paralelo');
            const contentSerie = document.getElementById('serie-tab');
            const contentParalelo = document.getElementById('paralelo-tab');
            
            tabSerie.addEventListener('click', () => {
                contentSerie.style.display = 'block';
                contentParalelo.style.display = 'none';
                tabSerie.classList.add('active');
                tabParalelo.classList.remove('active');
            });
            
            tabParalelo.addEventListener('click', () => {
                contentSerie.style.display = 'none';
                contentParalelo.style.display = 'block';
                tabParalelo.classList.add('active');
                tabSerie.classList.remove('active');
            });
        }
        
        // Función para calcular parámetros característicos del circuito
        function calcularParametrosCaracteristicos(R, L, C, tipo) {
            const omega0 = 1 / Math.sqrt(L * C); // Frecuencia natural
            let alpha, dampingRatio, dampingType;
            
            if (tipo === 'serie') {
                alpha = R / (2 * L);
            } else { // paralelo
                alpha = 1 / (2 * R * C);
            }
            
            const damping = alpha / omega0;
            
            if (alpha < omega0) {
                dampingType = "Subamortiguado (oscilatorio)";
                dampingRatio = damping;
            } else if (alpha > omega0) {
                dampingType = "Sobreamortiguado";
                dampingRatio = damping;
            } else {
                dampingType = "Críticamente amortiguado";
                dampingRatio = 1;
            }
            
            return {
                omega0,
                alpha,
                dampingRatio,
                dampingType,
                frecuenciaNatural: omega0 / (2 * Math.PI),
                periodoNatural: 2 * Math.PI / omega0
            };
        }
        
        // Función para formatear números para mostrar
        function formatNumber(num, decimals = 4) {
            return num.toFixed(decimals).replace(/\.?0+$/, '');
        }
        
        // Función para mostrar los parámetros del circuito y resultados
        function mostrarResultados(tipo, R, L, C, V0, I0, params, timeData, voltageData, currentData) {
            const prefix = tipo;
            const resultsPanel = document.getElementById(`results-${prefix}`);
            const paramsContainer = document.getElementById(`circuit-params-${prefix}`);
            const tableBody = document.querySelector(`#key-values-${prefix} tbody`);
            
            // Mostrar el panel de resultados
            resultsPanel.style.display = 'block';
            
            // Calcular valores estadísticos
            const maxVoltage = Math.max(...voltageData);
            const minVoltage = Math.min(...voltageData);
            const maxCurrent = Math.max(...currentData);
            const minCurrent = Math.min(...currentData);
            
            // Mostrar parámetros del circuito y características
            paramsContainer.innerHTML = `
                <div class="result-item">
                    <div class="result-label">Resistencia (R)</div>
                    <div class="result-value">${formatNumber(R)} Ω</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Inductancia (L)</div>
                    <div class="result-value">${formatNumber(L)} H</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Capacitancia (C)</div>
                    <div class="result-value">${formatNumber(C)} F</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Frecuencia natural (ω₀)</div>
                    <div class="result-value">${formatNumber(params.omega0)} rad/s</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Frecuencia natural (f₀)</div>
                    <div class="result-value">${formatNumber(params.frecuenciaNatural)} Hz</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Factor de amortiguamiento (α)</div>
                    <div class="result-value">${formatNumber(params.alpha)}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Relación de amortiguamiento (ζ)</div>
                    <div class="result-value">${formatNumber(params.dampingRatio)}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Tipo de respuesta</div>
                    <div class="result-value">${params.dampingType}</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Voltaje máximo</div>
                    <div class="result-value">${formatNumber(maxVoltage)} V</div>
                </div>
                <div class="result-item">
                    <div class="result-label">Corriente máxima</div>
                    <div class="result-value">${formatNumber(maxCurrent)} A</div>
                </div>
            `;
            
            // Mostrar valores clave en la tabla
            tableBody.innerHTML = '';
            
            // Seleccionar puntos clave para mostrar (inicio, picos, final)
            const keyIndices = [];
            const step = Math.floor(timeData.length / 10); // Mostrar ~10 puntos
            
            for (let i = 0; i < timeData.length; i += step) {
                keyIndices.push(i);
            }
            
            // Asegurarse de incluir el último punto
            if (keyIndices[keyIndices.length - 1] !== timeData.length - 1) {
                keyIndices.push(timeData.length - 1);
            }
            
            // Llenar la tabla con los valores seleccionados
            keyIndices.forEach(index => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatNumber(timeData[index], 6)}</td>
                    <td>${formatNumber(voltageData[index], 4)}</td>
                    <td>${formatNumber(currentData[index], 4)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Función para calcular la respuesta RLC usando el método de Euler
        function calcularRespuesta(tipo) {
            const prefix = tipo;
            
            // Obtener parámetros del circuito
            const R = parseFloat(document.getElementById(`R_${prefix}`).value);
            const L = parseFloat(document.getElementById(`L_${prefix}`).value);
            const C = parseFloat(document.getElementById(`C_${prefix}`).value);
            const V0 = parseFloat(document.getElementById(`V0_${prefix}`).value);
            const I0 = parseFloat(document.getElementById(`I0_${prefix}`).value);
            
            // Obtener parámetros de simulación
            const tMax = parseFloat(document.getElementById(`tmax_${prefix}`).value);
            const dt = parseFloat(document.getElementById(`dt_${prefix}`).value);
            
            // Validación exhaustiva de valores
            if (isNaN(R) || isNaN(L) || isNaN(C) || isNaN(V0) || isNaN(I0) || isNaN(tMax) || isNaN(dt)) {
                showStatus(prefix, "Error: Todos los campos deben ser números válidos", true);
                return;
            }
            
            if (R <= 0 || L <= 0 || C <= 0 || tMax <= 0 || dt <= 0) {
                showStatus(prefix, "Error: R, L, C, tmax y dt deben ser valores positivos", true);
                return;
            }
            
            if (dt >= tMax) {
                showStatus(prefix, "Error: El paso de tiempo debe ser menor que el tiempo final", true);
                return;
            }
            
            try {
                // Calcular parámetros característicos
                const params = calcularParametrosCaracteristicos(R, L, C, tipo);
                
                // Calcular usando el método de Euler
                const { timeData, voltageData, currentData } = resolverConEuler(R, L, C, V0, I0, tMax, dt, tipo);
                
                // Guardar datos para posible exportación
                currentSimulationData = {
                    timeData, voltageData, currentData, params,
                    circuitParams: { R, L, C, V0, I0 },
                    simulationParams: { tMax, dt }
                };
                
                // Mostrar resultados y gráfico
                mostrarResultados(tipo, R, L, C, V0, I0, params, timeData, voltageData, currentData);
                mostrarGrafico(timeData, voltageData, currentData, tipo);
                
                showStatus(prefix, `Simulación completada con ${timeData.length} puntos. Tipo: ${params.dampingType}`);
            } catch (error) {
                showStatus(prefix, `Error en la simulación: ${error.message}`, true);
                console.error("Error en calcularRespuesta:", error);
            }
        }
        
        // Función que implementa el método de Euler para resolver el circuito RLC
        function resolverConEuler(R, L, C, V0, I0, tMax, dt, tipo) {
            const timeData = [];
            const voltageData = [];
            const currentData = [];
            
            // Condiciones iniciales
            let t = 0;
            let Vc = V0;
            let Il = I0;
            
            // Número de pasos
            const numSteps = Math.ceil(tMax / dt);
            
            // Para circuito serie: dVc/dt = Il/C, dIl/dt = (-Vc - R*Il)/L
            // Para circuito paralelo: dVc/dt = Il/C - Vc/(R*C), dIl/dt = -Vc/L
            
            for (let i = 0; i <= numSteps; i++) {
                // Guardar los valores actuales
                timeData.push(t);
                voltageData.push(Vc);
                currentData.push(Il);
                
                // Calcular las derivadas según el tipo de circuito
                let dVc_dt, dIl_dt;
                
                if (tipo === 'serie') {
                    dVc_dt = Il / C;
                    dIl_dt = (-Vc - R * Il) / L;
                } else { // paralelo
                    dVc_dt = Il / C - Vc / (R * C);
                    dIl_dt = -Vc / L;
                }
                
                // Aplicar el método de Euler
                Vc = Vc + dVc_dt * dt;
                Il = Il + dIl_dt * dt;
                t = t + dt;
            }
            
            return { timeData, voltageData, currentData };
        }
        
        // Función para mostrar el gráfico
        function mostrarGrafico(timeData, voltageData, currentData, tipo) {
            const ctx = document.getElementById('responseChart').getContext('2d');
            
            // Destruir el gráfico anterior si existe
            if (responseChart) {
                responseChart.destroy();
            }
            
            // Configurar escalas automáticas mejoradas
            const maxVoltage = Math.max(1, ...voltageData.map(Math.abs));
            const maxCurrent = Math.max(0.1, ...currentData.map(Math.abs));
            
            responseChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: timeData,
                    datasets: [
                        {
                            label: `Voltaje en capacitor (V) - ${tipo}`,
                            data: voltageData,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y',
                            pointRadius: 0
                        },
                        {
                            label: `Corriente en inductor (A) - ${tipo}`,
                            data: currentData,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            tension: 0.1,
                            yAxisID: 'y1',
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tiempo (s)'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Voltaje (V)'
                            },
                            min: -maxVoltage * 1.1,
                            max: maxVoltage * 1.1
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Corriente (A)'
                            },
                            min: -maxCurrent * 1.1,
                            max: maxCurrent * 1.1,
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toFixed(4);
                                        label += context.datasetIndex === 0 ? ' V' : ' A';
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Inicialización cuando el DOM esté completamente cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar pestañas
            setupTabs();
            
            // Asignar eventos a los botones
            document.getElementById('btn-serie').addEventListener('click', () => calcularRespuesta('serie'));
            document.getElementById('btn-paralelo').addEventListener('click', () => calcularRespuesta('paralelo'));
            
            // Calcular automáticamente al cargar la página
            calcularRespuesta('serie');
        });
    </script>
</body>
</html>
